<!DOCTYPE html>

<html>
<head>
  <title>Lazybones</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="public/main.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="index.html">
                  README.md
                </a>
              
                
                <a class="source" href="lazybones.html">
                  lazybones.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>Lazybones</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> merge = <span class="hljs-built_in">require</span>(<span class="hljs-string">"plain-merge"</span>),
    Promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">"pouchdb/extras/promise"</span>),
    PouchError = <span class="hljs-built_in">require</span>(<span class="hljs-string">"pouchdb/lib/deps/errors"</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">noop</span><span class="hljs-params">()</span></span>{}</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>PouchDB Plugin</h2>
<p>This is the PouchDB plugin method that attaches a <code>lazybones()</code> method to newly created PouchDB instances. The <code>lazybones()</code> will create a sync method (with options) that is tied directly to the database it was called on.</p><pre><code class="lang-js">PouchDB.plugin(Lazybones());
<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> PouchDB(<span class="hljs-string">"mydb"</span>);
db.lazybones(); <span class="hljs-comment">// returns a sync function</span>
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Lazybones = <span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(gdef)</span> </span>{
    <span class="hljs-keyword">return</span> { lazybones: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(defaults)</span> </span>{
        <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method, model, options)</span> </span>{
            options = merge.defaults({}, options, defaults, gdef, { database: db });
            <span class="hljs-keyword">return</span> Lazybones.sync.call(<span class="hljs-keyword">this</span>, method, model, options);
        }
    } };
}

<span class="hljs-keyword">var</span> methodMap = {
    create: <span class="hljs-string">"post"</span>,
    update: <span class="hljs-string">"put"</span>,
    patch: <span class="hljs-string">"put"</span>,
    <span class="hljs-keyword">delete</span>: <span class="hljs-string">"remove"</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2>Options &amp; Defaults</h2>
<p>These are the default options used by Lazybones. Modify this variable to change the default options globally.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>Lazybones.defaults = {
    success: noop,
    error: noop,</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4>options.changes</h4>
<p>This property determines if sync uses the changes feed when fetching data. This forces sync into an alternate mode that avoids Backbone&#39;s <code>success</code> and <code>error</code> callbacks and updates the</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>    changes: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4>options.query</h4>
<p>This property can be a map function or the id of a view. This is what gets passed as the first argument to <code>db.query()</code>.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>    query: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h4>options.rowKey</h4>
<p>The key to extract from view rows on query fetches.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>    rowKey: <span class="hljs-string">"doc"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h4>options.options</h4>
<p>These are specific options for each PouchDB method.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>    options: {
        get: {},
        query: { include_docs: <span class="hljs-literal">true</span>, returnDocs: <span class="hljs-literal">false</span> },
        allDocs: { include_docs: <span class="hljs-literal">true</span> },
        changes: { returnDocs: <span class="hljs-literal">false</span> }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h4>options.fetch()</h4>
<p>This method controls how the sync function will fetch data. The method currently handles normal gets and queries.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>    fetch: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, db, options)</span> </span>{
        <span class="hljs-comment">// a single model</span>
        <span class="hljs-keyword">if</span> (!isCollection(model)) <span class="hljs-keyword">return</span> db.get(model.id, options.options.get);

        <span class="hljs-comment">// process query requests</span>
        <span class="hljs-keyword">if</span> (options.query) <span class="hljs-keyword">return</span> db.query(options.query, options.options.query);

        <span class="hljs-comment">// regular collection fetch</span>
        <span class="hljs-keyword">return</span> db.allDocs(options.options.allDocs);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h4>options.process()</h4>
<p>This method parses the result from PouchDB before sending it to Backbone.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>    process: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(res, method, model, options)</span> </span>{
        <span class="hljs-comment">// parse non-document responses</span>
        <span class="hljs-keyword">if</span> (res._id == <span class="hljs-literal">null</span> &amp;&amp; res._rev == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// write result</span>
            <span class="hljs-keyword">if</span> (method !== <span class="hljs-string">"read"</span>) <span class="hljs-keyword">return</span> { _id: res.id, _rev: res.rev };

            <span class="hljs-comment">// view result</span>
            <span class="hljs-keyword">if</span> (res.rows != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (isCollection(model)) <span class="hljs-keyword">return</span> res.rows.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> </span>{
                    <span class="hljs-keyword">return</span> row[options.rowKey];
                });

                <span class="hljs-comment">// grab just the first row for models</span>
                <span class="hljs-keyword">return</span> res.rows.length ? res.rows[<span class="hljs-number">0</span>][options.rowKey] : <span class="hljs-literal">null</span>;
            }

            <span class="hljs-comment">// changes feed result</span>
            <span class="hljs-keyword">if</span> (res[options.rowKey] != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> res[options.rowKey];
        }

        <span class="hljs-keyword">return</span> res;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2>Sync</h2>
<p>This is the heart of Lazybones. Use it wherever <code>Backbone.sync</code> is used.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>Lazybones.sync = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method, model, options)</span> </span>{
    <span class="hljs-keyword">var</span> self, dbMethod, db, onChange, promise, chgopts, chgfilter, processed, processPromise;

    <span class="hljs-comment">// resolve method and database</span>
    self = <span class="hljs-keyword">this</span>;
    options = merge.defaults({}, options, getSyncOptions(model), getSyncOptions(model.collection), Lazybones.defaults);
    method = method.toLowerCase().trim();
    db = getDatabase(options) || getDatabase(model);
    <span class="hljs-keyword">if</span> (db == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Missing PouchDB database."</span>);

    <span class="hljs-comment">// deal with writes</span>
    <span class="hljs-keyword">if</span> (method !== <span class="hljs-string">"read"</span>) {
        promise = db[methodMap[method]](model.toJSON(), options.options[methodMap[method]]);
    }

    <span class="hljs-comment">// deal with normal reads</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!options.changes) {
        promise = options.fetch.call(self, model, db, options);
        <span class="hljs-keyword">if</span> (promise == <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> promise.then !== <span class="hljs-string">"function"</span>) {
            promise = Promise.resolve(promise);
        }
    }

    <span class="hljs-comment">// deal with changes feed reads</span>
    <span class="hljs-keyword">else</span> {
        chgopts = merge.defaults({
            include_docs: <span class="hljs-literal">true</span>
        }, options.changes, options.options.changes);

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> chgopts.filter === <span class="hljs-string">"function"</span>) {
            chgfilter = chgopts.filter;
            chgopts.filter = <span class="hljs-literal">null</span>;
        }

        promise = db.changes(chgopts);

        onChange = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> </span>{
            <span class="hljs-keyword">var</span> val = options.process.call(self, row, method, model, options);
            <span class="hljs-keyword">if</span> (chgfilter &amp;&amp; !chgfilter(val, row, options)) <span class="hljs-keyword">return</span>;
            model.set(val, merge.extend({ remove: <span class="hljs-literal">false</span> }, options));
        }

        promise.on(<span class="hljs-string">"create"</span>, onChange);
        promise.on(<span class="hljs-string">"update"</span>, onChange);

        promise.on(<span class="hljs-string">"delete"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> </span>{
            <span class="hljs-keyword">var</span> m = !isCollection(model) ? model : model.remove(row.id, options);

            <span class="hljs-keyword">if</span> (m) {
                <span class="hljs-keyword">var</span> val = options.process.call(self, row, method, model, options);
                m.set(val, options);
            }
        });

        <span class="hljs-comment">// return the changes object immediately</span>
        <span class="hljs-keyword">return</span> promise;
    }

    <span class="hljs-comment">// trigger the request event</span>
    model.trigger(<span class="hljs-string">'request'</span>, model, db, options);

    <span class="hljs-comment">// process the result into something that backbone can use</span>
    <span class="hljs-comment">// and ship result to success and error callbacks</span>
    <span class="hljs-keyword">return</span> promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(res)</span> </span>{
        options.success(options.process.call(self, res, method, model, options));
        <span class="hljs-keyword">return</span> res;
    }).catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
        options.error(err);
        <span class="hljs-keyword">throw</span> err;
    });
}

<span class="hljs-keyword">var</span> isCollection =
Lazybones.isCollection = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span> </span>{
    <span class="hljs-keyword">return</span> v != <span class="hljs-literal">null</span> &amp;&amp;
        <span class="hljs-built_in">Array</span>.isArray(v.models) &amp;&amp;
        <span class="hljs-keyword">typeof</span> v.model === <span class="hljs-string">"function"</span> &amp;&amp;
        <span class="hljs-keyword">typeof</span> v.add === <span class="hljs-string">"function"</span> &amp;&amp;
        <span class="hljs-keyword">typeof</span> v.remove === <span class="hljs-string">"function"</span>;
}

Lazybones.isModel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val)</span> </span>{
    <span class="hljs-keyword">return</span> val != <span class="hljs-literal">null</span> &amp;&amp;
        <span class="hljs-keyword">typeof</span> val.cid === <span class="hljs-string">"string"</span> &amp;&amp;
        <span class="hljs-keyword">typeof</span> val.attributes === <span class="hljs-string">"object"</span> &amp;&amp;
        <span class="hljs-keyword">typeof</span> val.get === <span class="hljs-string">"function"</span> &amp;&amp;
        <span class="hljs-keyword">typeof</span> val.set === <span class="hljs-string">"function"</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSyncOptions</span><span class="hljs-params">(m)</span> </span>{
    <span class="hljs-keyword">return</span> m &amp;&amp; lookup(m, [<span class="hljs-string">"syncOptions"</span>,<span class="hljs-string">"sync_options"</span>]);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDatabase</span><span class="hljs-params">(m)</span> </span>{
    <span class="hljs-keyword">return</span> m &amp;&amp; (lookup(m, [<span class="hljs-string">"pouch"</span>,<span class="hljs-string">"pouchdb"</span>,<span class="hljs-string">"db"</span>,<span class="hljs-string">"database"</span>]) || getDatabase(m.collection));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lookup</span><span class="hljs-params">(o, keys)</span> </span>{
    <span class="hljs-keyword">var</span> v, i;
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> keys) {
        v = o[keys[i]];
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-string">"function"</span>) {
            <span class="hljs-keyword">return</span> v.call(o, <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>));
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v !== <span class="hljs-string">"undefined"</span>) <span class="hljs-keyword">return</span> v;
    }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
