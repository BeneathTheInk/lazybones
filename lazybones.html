<!DOCTYPE html>

<html>
<head>
  <title>Lazybones</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="public/main.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="index.html">
                  README.md
                </a>
              
                
                <a class="source" href="document.html">
                  document.js
                </a>
              
                
                <a class="source" href="lazybones.html">
                  lazybones.js
                </a>
              
                
                <a class="source" href="sync.html">
                  sync.js
                </a>
              
                
                <a class="source" href="utils.html">
                  utils.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>Lazybones</h1>
<p>Lazybones is a modified Backbone collection that integrates with PouchDB. By combining Backbone&#39;s object-oriented approach with PouchDB&#39;s super flexible databases, Lazybones provides a highly-functional API for storing and manipulating data in the browser and Node.js.</p><p>A deeper understanding of <a href="http://backbonejs.org">Backbone</a> is recommended since many of Lazybones methods and concepts are inherited directly from Backbone. Knowledge of PouchDB&#39;s API is also recommended, but not required to use Lazybones.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">"underscore"</span>),
    Backbone = <span class="hljs-built_in">require</span>(<span class="hljs-string">"backbone"</span>),
    PouchDB = <span class="hljs-built_in">require</span>(<span class="hljs-string">"pouchdb"</span>),
    Promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">"bluebird"</span>);

<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./utils"</span>),
    Document = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./document"</span>),
    sync = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./sync"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>Constructor</h2>
<p>To use Lazybones, create a new database instance with a name or PouchDB instance:</p><pre><code class="lang-javascript"><span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> Lazybones(<span class="hljs-string">"testdb"</span>);
</code></pre>
<p>Databases are always created with an associated PouchDB instance. If PouchDB needs to be specially initialized, instances can be created ahead of time and passed in via <code>options.pouch</code>. Otherwise, the Lazybones constructor will create a new PouchDB instance from the <code>name</code> argument.</p><h4>Arguments</h4>
<ul>
<li><strong>name</strong> <em>PouchDB | string</em>  - A PouchDB instance or a database name. This could also be <code>null</code> or an array like a traditional Backbone collection, however then the PouchDB instance must be passed via <code>options.pouch</code>.</li>
<li><strong>options</strong> <em>object; optional</em> - An object of options to initiate the database with. This variable is passed directly to the <code>Backbone.Collection</code> constructor.<ul>
<li><strong>options.pouch</strong> <em>object | PouchDB</em> - An instance of PouchDB or an object of options to pass to the PouchDB constructor.</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = Backbone.Collection.extend({

    constructor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(models, options)</span> </span>{
        options = options || {};
        <span class="hljs-keyword">var</span> pouch;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> models === <span class="hljs-string">"string"</span>) {
            pouch = <span class="hljs-keyword">new</span> PouchDB(models, options.pouch);
            models = <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">if</span> (models <span class="hljs-keyword">instanceof</span> PouchDB) {
            pouch = models;
            models = <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.pouch) {
            pouch = options.pouch;
        }

        <span class="hljs-keyword">if</span> (!(pouch <span class="hljs-keyword">instanceof</span> PouchDB)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> utils.LazyError(<span class="hljs-string">"INVALID_POUCH"</span>);
        }

        <span class="hljs-keyword">this</span>.pouch = pouch;
        pouch.once(<span class="hljs-string">"destroyed"</span>, <span class="hljs-keyword">this</span>.trigger.bind(<span class="hljs-keyword">this</span>, <span class="hljs-string">"destroyed"</span>));

        <span class="hljs-keyword">return</span> Backbone.Collection.call(<span class="hljs-keyword">this</span>, models, options);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2>Instance Properties &amp; Methods</h2>
<p>These properties are addition to methods provided by <code>Backbone.Collection</code>.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>    model: Document,
    parse: utils.parse,
    sync: <span class="hljs-built_in">require</span>(<span class="hljs-string">"./sync"</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h3>connect()</h3>
<p>Listens to the PouchDB changes feed and sets any changes on the in-memory <a href="document.html">Documents</a>. By default, the changes are &quot;live&quot; meaning that changes will be listened for continuously. Use <code>db.disconnect()</code> to stop a live connection.</p><p><code>this</code> is returned for method chaining.</p><h4>Arguments</h4>
<ul>
<li><strong>options</strong> <em>object; optional</em> - An object of properties that are passed to <code>pouch.changes()</code>. All PouchDB changes properties are allowed, except for <code>include_docs</code> which is set to true. Below are the properties with default values. Please see the <a href="http://pouchdb.com/api.html#changes">PocuhDB documentation</a> for the remaining options.<ul>
<li><strong>options.live</strong> <em>boolean</em> - The database will continuously listen for changes, keeping the in-memory documents in sync with those in the database. Setting this to <code>false</code> will result in the database disconnecting as soon as it is has been caught up. Default value is <code>true</code>.</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    connect: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> </span>{
        <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

        <span class="hljs-comment">// always disconnect first</span>
        <span class="hljs-keyword">this</span>.disconnect();

        <span class="hljs-comment">// create/update function</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onChange</span><span class="hljs-params">(row)</span> </span>{
            self.add(row.doc, { merge: <span class="hljs-literal">true</span>, pouch: self.pouch });
        }

        <span class="hljs-comment">// uptodate event should only be called once per connection</span>
        <span class="hljs-keyword">var</span> onUpToDate = _.once(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(info)</span> </span>{
            self.trigger(<span class="hljs-string">"uptodate"</span>, info);
        });

        <span class="hljs-comment">// the listener</span>
        <span class="hljs-keyword">var</span> listener =
        <span class="hljs-keyword">this</span>._pouchChange = <span class="hljs-keyword">this</span>.pouch.changes(_.extend({
            live: <span class="hljs-literal">true</span>
        }, options, {
            include_docs: <span class="hljs-literal">true</span>
        }))

        <span class="hljs-comment">// listen for uptodate</span>
        .on(<span class="hljs-string">"uptodate"</span>, onUpToDate)
        .on(<span class="hljs-string">"complete"</span>, onUpToDate) <span class="hljs-comment">// when live = false</span>

        <span class="hljs-comment">// creates and updates are handled the same</span>
        .on(<span class="hljs-string">"create"</span>, onChange)
        .on(<span class="hljs-string">"update"</span>, onChange)

        <span class="hljs-comment">// remove everything marked as a delete</span>
        .on(<span class="hljs-string">"delete"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> </span>{
            self.remove(row.id);
        });

        <span class="hljs-comment">// catch any terminating errors</span>
        Promise.cast(listener.catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
            self.trigger(<span class="hljs-string">"error"</span>, e);
        }))

        .finally(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resp)</span> </span>{
            <span class="hljs-comment">// clean up</span>
            self.disconnect();

            <span class="hljs-comment">// announce disconnect</span>
            self.trigger(<span class="hljs-string">"disconnect"</span>, listener, resp);
        });

        <span class="hljs-comment">// annouce the connection</span>
        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">"connect"</span>, listener);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3>disconnect()</h3>
<p>Stops the database from listening to the PouchDB changes feed. This method has no effect if the database is not currently connected.</p><p><code>this</code> is returned for method chaining.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>    disconnect: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// only disconnect if connected</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isConnected()) {
            <span class="hljs-keyword">this</span>._pouchChange.cancel();
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._pouchChange;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3>isConnected()</h3>
<p>Returns <code>true</code> if the Lazybones instance is actively listening to the PouchDB changes feed.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>    isConnected: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._pouchChange != <span class="hljs-literal">null</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3>destroy()</h3>
<p>Destroys the underlying PouchDB database. This will keep all the existing documents in-memory, so call <code>db.reset()</code> to remove those as well. The Lazybones instance should not used after this method has been called.</p><p>This method returns a promise that is resolved when the database is destroyed.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>    destroy: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// disconnect live connection</span>
        <span class="hljs-keyword">this</span>.disconnect();

        <span class="hljs-comment">// destroy the underlying pouch database</span>
        <span class="hljs-keyword">return</span> Promise.cast(<span class="hljs-keyword">this</span>.pouch.destroy()).bind(<span class="hljs-keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3>_prepareModel()</h3>
<p>Any models created from the collection should have references back to the underlying PouchDB instance. This helps during syncing, but is also useful inside the model classes. This custom <code>_prepareModel()</code> method overrides Backbone&#39;s to ensure the PouchDB is always passed along to documents.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>    _prepareModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(attrs, options)</span> </span>{
        options = options || {};
        <span class="hljs-keyword">if</span> (options.pouch == <span class="hljs-literal">null</span>) options.pouch = <span class="hljs-keyword">this</span>.pouch;
        <span class="hljs-keyword">return</span> Backbone.Collection.prototype._prepareModel.call(<span class="hljs-keyword">this</span>, attrs, options);
    }

}, {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2>Static Methods &amp; Properties</h2>
<ul>
<li><strong>Lazybones.utils</strong> <em>object</em> - Lazybones and PouchDB utility methods.</li>
<li><strong>Lazybones.Document</strong> <em>function</em> - The Document constructor, which is a subclass of <code>Backbone.Model</code>.</li>
<li><strong>Lazybones.sync</strong> <em>function</em> - The Lazybones sync method. This replaces <code>Backbone.sync</code>.</li>
<li><strong>Lazybones.extend</strong> <em>function</em> - Creates a subclass of Lazybones. This is the same method that Backbone uses.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    VERSION: <span class="hljs-string">'0.2.1'</span>,
    utils: utils,
    sync: sync,
    Document: Document,
    Backbone: Backbone,
    PouchDB: PouchDB

});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
