<!DOCTYPE html>

<html>
<head>
  <title>Utils</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="document.html">
                  document.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="sync.html">
                  sync.js
                </a>
              
                
                <a class="source" href="utils.html">
                  utils.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1>Utils</h1>
<p>These are utility methods used by Lazybones and are accessible via <code>Lazybones.utils</code>.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">"underscore"</span>),
    PouchDB = <span class="hljs-built_in">require</span>(<span class="hljs-string">"pouchdb"</span>),
    Promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">"bluebird"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h3>uuid()</h3>
<p>Generates a random UUID. This method is taken directly from PouchDB.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>exports.uuid = PouchDB.utils.uuid;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h3>Promise</h3>
<p>A direct reference to the Bluebird Promise object.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>exports.Promise = Promise;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3>pouchOptionKeys</h3>
<p>Lists of option keys by method names that can be used in PouchDB requests. This allows option objects to be sanitized before being passed to PouchDB.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>exports.pouchOptionKeys = {
    get: [ <span class="hljs-string">"rev"</span>, <span class="hljs-string">"revs"</span>, <span class="hljs-string">"revs_info"</span>, <span class="hljs-string">"open_revs"</span>, <span class="hljs-string">"conflicts"</span>, <span class="hljs-string">"attachments"</span>, <span class="hljs-string">"local_seq"</span>, <span class="hljs-string">"ajax"</span> ],
    allDocs: [ <span class="hljs-string">"include_docs"</span>, <span class="hljs-string">"conflicts"</span>, <span class="hljs-string">"attachments"</span>, <span class="hljs-string">"startkey"</span>, <span class="hljs-string">"endkey"</span>, <span class="hljs-string">"inclusive_end"</span>, <span class="hljs-string">"limit"</span>, <span class="hljs-string">"skip"</span>, <span class="hljs-string">"descending"</span>, <span class="hljs-string">"key"</span>, <span class="hljs-string">"keys"</span> ],
    changes: [ <span class="hljs-string">"include_docs"</span>, <span class="hljs-string">"conflicts"</span>, <span class="hljs-string">"attachments"</span>, <span class="hljs-string">"filter"</span>, <span class="hljs-string">"doc_ids"</span>, <span class="hljs-string">"since"</span>, <span class="hljs-string">"live"</span>, <span class="hljs-string">"limit"</span>, <span class="hljs-string">"style"</span>, <span class="hljs-string">"view"</span>, <span class="hljs-string">"returnDocs"</span>, <span class="hljs-string">"batch_size"</span> ]
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3>parse()</h3>
<p>Parses raw PouchDB document data by converting any ISO dates into Date objects. This method available on all Document and Lazybones instances.</p><h4>Arguments</h4>
<ul>
<li><strong>attrs</strong> <em>object</em> - A raw document object. This usually comes straight from a PouchDB <code>get()</code> request.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">// iso date regular expression</span>
<span class="hljs-keyword">var</span> iso_date_regex = <span class="hljs-regexp">/\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z)/</span>;

<span class="hljs-keyword">var</span> parse =
exports.parse = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(attrs)</span> </span>{
    <span class="hljs-comment">// process arrays of attributes</span>
    <span class="hljs-keyword">if</span> (_.isArray(attrs)) {
        attrs.forEach(parse, <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> attrs;
    }

    <span class="hljs-comment">// convert dates</span>
    _.each(attrs, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val, key)</span> </span>{
        <span class="hljs-keyword">if</span> (_.isString(val) &amp;&amp; iso_date_regex.test(val)) {
            <span class="hljs-keyword">var</span> time = <span class="hljs-built_in">Date</span>.parse(val);
            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(time)) attrs[key] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(time);
        }
    });

    <span class="hljs-keyword">return</span> attrs;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3>asyncDefer()</h3>
<p>Creates a deferred promise that is not resolved until the next system tick.</p><h4>Arguments</h4>
<ul>
<li><strong>data</strong> <em>mixed</em> - Data to pass along through the promise.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.asyncDefer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resolve)</span> </span>{
        process.nextTick(resolve.bind(<span class="hljs-literal">null</span>, data));
    });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3>LazyError()</h3>
<p>A custom error class that all errors thrown by Lazybones are wrapped in.</p><h4>Arguments</h4>
<ul>
<li><strong>code</strong> <em>string</em> - The specific error code. The default value is <code>UNKNOWN_ERROR</code>.</li>
<li><strong>msg</strong> <em>string</em> - A custom error message. If this argument is not provided, the value is derived from the error code.</li>
</ul>
<h4>Instance Properties</h4>
<ul>
<li><strong>code</strong> <em>string</em> - The error code.</li>
<li><strong>message</strong> <em>string</em> - The error message and code.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">LazyError</span><span class="hljs-params">(code, msg)</span> </span>{
    <span class="hljs-built_in">Error</span>.call(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">var</span> code = _.isString(code) ? code.toUpperCase() : <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (!code || LazyError.errors[code] == <span class="hljs-literal">null</span>) code = <span class="hljs-string">"UNKNOWN_ERROR"</span>;

    <span class="hljs-keyword">this</span>.code = code;

    <span class="hljs-built_in">Object</span>.defineProperty(<span class="hljs-keyword">this</span>, <span class="hljs-string">"_message"</span>, {
        value: msg || LazyError.errors[code],
        writeable: <span class="hljs-literal">false</span>,
        enumerable: <span class="hljs-literal">false</span>,
        configurable: <span class="hljs-literal">false</span>
    });
}

exports.LazyError = LazyError;
LazyError.prototype = <span class="hljs-built_in">Object</span>.create(<span class="hljs-built_in">Error</span>.prototype);

LazyError.prototype.name = <span class="hljs-string">"LazyError"</span>;

<span class="hljs-built_in">Object</span>.defineProperty(LazyError.prototype, <span class="hljs-string">"message"</span>, {
    get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._message + <span class="hljs-string">" ("</span> + <span class="hljs-keyword">this</span>.code + <span class="hljs-string">")"</span>;
    },
    enumerable: <span class="hljs-literal">true</span>,
    configurable: <span class="hljs-literal">false</span>
});

LazyError.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name + <span class="hljs-string">": "</span> + <span class="hljs-keyword">this</span>.message;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h4>Error Codes</h4>
<p>These are the error codes used by LazyError and their default messages. Custom error codes can be created by adding to this list.</p>
            </div>
            
            <div class="content"><div class='highlight'><pre>LazyError.errors = {
    POUCH_ERROR: <span class="hljs-string">"PouchDB had an error."</span>,
    INVALID_DOCUMENT: <span class="hljs-string">"Expecting a valid document."</span>,
    MISSING_ID: <span class="hljs-string">"Document is missing '_id' attribute."</span>,
    MISSING_REVISION: <span class="hljs-string">"Document is missing '_rev' attribute."</span>,
    MISSING_DATABASE: <span class="hljs-string">"Document is missing database reference."</span>,
    ILLEGAL_UPDATE: <span class="hljs-string">"Refusing to update this document."</span>,
    WRITE_CANCELLED: <span class="hljs-string">"Database write was canceled."</span>,
    DATABASE_DESTROYED: <span class="hljs-string">"Database has been destroyed."</span>,
    UNKNOWN_ERROR: <span class="hljs-string">"An unknown error occurred."</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3>transformPouchError()</h3>
<p>Transforms a PouchError into a LazyError and then throws it. If the passed error is not a PouchError, the original error is thrown without modification.</p><h4>Arguments</h4>
<ul>
<li><strong>error</strong> <em>Error</em> - Any error object.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.transformPouchError = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> </span>{
    <span class="hljs-comment">// make sure this is a real pouch error</span>
    <span class="hljs-keyword">if</span> (!(e || e.error)) <span class="hljs-keyword">throw</span> e;

    <span class="hljs-keyword">var</span> nerr = <span class="hljs-keyword">new</span> LazyError(<span class="hljs-string">"POUCH_ERROR"</span>, e.message);
    nerr.error = <span class="hljs-literal">true</span>; <span class="hljs-comment">// keep it consistent</span>
    nerr.status = e.status;
    nerr.pouch_name = e.name;
    <span class="hljs-keyword">throw</span> nerr;
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
